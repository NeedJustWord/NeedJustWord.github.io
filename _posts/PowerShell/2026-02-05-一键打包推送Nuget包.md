---
layout: post
title: 一键打包推送Nuget包
categories: PowerShell
tags: [PowerShell, Nuget] 
---

### 问题

分布式项目，项目数量多，每个项目要打包的Nuget包也多，操作繁琐



### 需求

一键打包推送Nuget包到私有Nuget服务器，跳过繁琐的命令过程



### PowerShell脚本内容

```powershell
function Start-PublishNuget {
    param(
        [ValidateNotNullOrEmpty()]
        [string]$Path = ($pwd).Path,
        [string]$Version,
        [switch]$InputVersion,
        [switch]$SkipDomainShared,
        [switch]$SkipHttpApiClient,
        [switch]$SkipApplicationContracts,
        [switch]$SkipCreateNugetFile
    )

    if (-not (Test-Path $Path)) {
        Write-Output "Path路径不存在,请检查"
        return
    }

    $CurrentRoot = ($pwd).Path
    $SolutionRoot = $Path

    Set-Location $SolutionRoot

    if ((Split-Path $SolutionRoot -Leaf) -eq "src") {
        $SolutionRoot = Split-Path $SolutionRoot -Parent
    }
    elseif ($SolutionRoot -match "[\\/]src[\\/]") {
        do {
            $SolutionRoot = Split-Path $SolutionRoot -Parent
        } until (Test-Path "$SolutionRoot\src")
    }
    elseif (-not (Test-Path "$SolutionRoot\src")) {
        Write-Output "未找到解决方案目录,请检查"
        return
    }

    PublishNugetSolution $SolutionRoot $Version $InputVersion $SkipDomainShared $SkipHttpApiClient $SkipApplicationContracts $SkipCreateNugetFile

    Set-Location $CurrentRoot

    <#
    .SYNOPSIS
    推送Nuget包

    .DESCRIPTION
    在指定目录下查找解决方案目录，生成Domain.Shared、HttpApi.Client、Application.Contracts三个项目的Nuget包并推送
    也可通过输入参数跳过项目、跳过Nuget包生成、指定版本号、手动输入版本号
    版本号优先级：Version(指定版本号) > InputVersion(手动输入版本号) > 扫描最新修改时间的版本号

    .PARAMETER Path
    指定目录,默认当前路径

    .PARAMETER Version
    指定版本号

    .PARAMETER InputVersion
    手动输入版本号

    .PARAMETER SkipDomainShared
    跳过Domain.Shared项目

    .PARAMETER SkipHttpApiClient
    跳过HttpApi.Client项目

    .PARAMETER SkipApplicationContracts
    跳过Application.Contracts项目

    .PARAMETER SkipCreateNugetFile
    跳过生成Nuget包
    #>
}

function Start-PublishNugetSingle {
    param(
        [ValidateNotNullOrEmpty()]
        [string]$NugetDir = ($pwd).Path,
        [string]$Version,
        [switch]$InputVersion
    )

    if (-not (Test-Path $NugetDir)) {
        Write-Output "NugetDir路径不存在,请检查"
        return
    }

    $CurrentRoot = ($pwd).Path

    if ($NugetDir -match "[\\/]src[\\/]") {
        $ProjectName = (Get-Item $NugetDir).Parent.Parent.Name
    }
    else {
        $ProjectName = ""
    }

    Write-Output ""
    Write-Output "当前项目:$ProjectName"
    Write-Output "Nuget目录:$NugetDir"

    PublishNugetFile $ProjectName $NugetDir $Version $InputVersion

    Set-Location $CurrentRoot

    <#
    .SYNOPSIS
    推送单个Nuget包

    .DESCRIPTION
    推送Nuget目录下最新修改时间的Nuget包,也可通过输入参数指定版本号、手动输入版本号
    版本号优先级：Version(指定版本号) > InputVersion(手动输入版本号) > 扫描最新修改时间的版本号

    .PARAMETER NugetDir
    Nuget目录,默认当前路径

    .PARAMETER Version
    指定版本号

    .PARAMETER InputVersion
    手动输入版本号
    #>
}

function PublishNugetSolution {
    param(
        [string]$SolutionRoot,
        [string]$Version,
        [bool]$InputVersion,
        [bool]$SkipDomainShared,
        [bool]$SkipHttpApiClient,
        [bool]$SkipApplicationContracts,
        [bool]$SkipCreateNugetFile
    )

    $SolutionDirName = Split-Path $SolutionRoot -Leaf
    Write-Output ""
    Write-Output "解决方案目录:$SolutionDirName"
    Write-Output "指定版本号:$Version   手动输入版本号:$InputVersion"
    Write-Output "跳过Domain.Shared项目:$SkipDomainShared   跳过HttpApi.Client项目:$SkipHttpApiClient   跳过Application.Contracts项目:$SkipApplicationContracts   跳过生成Nuget包:$SkipCreateNugetFile"

    if (-not $SkipDomainShared) {
        PublishNugetProject $SolutionRoot $SolutionDirName "Domain.Shared" $Version $InputVersion $SkipCreateNugetFile
    }
    if (-not $SkipHttpApiClient) {
        PublishNugetProject $SolutionRoot $SolutionDirName "HttpApi.Client" $Version $InputVersion $SkipCreateNugetFile
    }
    if (-not $SkipApplicationContracts) {
        PublishNugetProject $SolutionRoot $SolutionDirName "Application.Contracts" $Version $InputVersion $SkipCreateNugetFile
    }
}

function PublishNugetProject {
    param(
        [string]$SolutionRoot,
        [string]$SolutionDirName,
        [string]$ProjectSubName,
        [string]$Version,
        [bool]$InputVersion,
        [bool]$SkipCreateNugetFile
    )

    $ProjectName = "Company." + ($SolutionDirName -replace "-", ".") + "." + $ProjectSubName

    Write-Output ""
    Write-Output "当前项目:$ProjectName"

    $ProjectDir = $SolutionRoot + "\src\" + $ProjectName
    if (-not $SkipCreateNugetFile) {
        Set-Location $ProjectDir
        dotnet build -c Debug
        dotnet pack -c Debug
    }

    $NugetDir = $ProjectDir + "\bin\Debug"
    Write-Output "Nuget目录:$NugetDir"

    if (Test-Path $NugetDir) {
        PublishNugetFile $ProjectName $NugetDir $Version $InputVersion
    }
    else {
        Write-Output "Nuget目录不存在,请检查Nuget包是否已生成"
    }
}

function PublishNugetFile {
    param(
        [string]$ProjectName,
        [string]$NugetDir,
        [string]$Version,
        [bool]$InputVersion
    )

    Set-Location $NugetDir

    if ($ProjectName) {
        $FileNamePrefix = $ProjectName + "."
    }
    else {
        $FileNamePrefix = "*."
    }

    if ($Version) {
        $FileName = $FileNamePrefix + $Version + ".nupkg"
        if ($FileName -match "\*\.") {
            $FileName = SearchNugetFile $FileName
        }
    }
    elseif ($InputVersion) {
        $Version = Read-Host -Prompt "请输入版本号"
        $FileName = $FileNamePrefix + $Version + ".nupkg"
        if ($FileName -match "\*\.") {
            $FileName = SearchNugetFile $FileName
        }
    }
    else {
        $FileName = SearchNugetFile ($FileNamePrefix + "*.nupkg")
    }

    Write-Output "Nuget文件名:$FileName"

    if ($FileName -and (Test-Path $FileName)) {
        Write-Output ""
        dotnet nuget push --api-key [key] -s [nuget server] $FileName
    }
    else {
        Write-Output "Nuget文件不存在,请检查Nuget包是否已生成"
    }
}

function SearchNugetFile {
    param(
        [string]$Filter
    )

    Write-Information "查找文件:$Filter" -InformationAction Continue
    $FileName = (Get-ChildItem -Filter $Filter -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1).Name

    return $FileName
}

Export-ModuleMember -Function Start-PublishNuget,Start-PublishNugetSingle
```



### PowerShell创建自定义模块

```powershell
#打开PowerShell，执行以下命令

Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
#修改当前用户的执行策略为RemoteSigned，输入a回车确定更改执行策略

Write-Output $env:PSModulePath
#打印模块路径，打印内容如下：
#F:\系统文件夹\文档\WindowsPowerShell\Modules;C:\Program Files\WindowsPowerShell\Modules;C:\WINDOWS\system32\WindowsPowerShell\v1.0\Modules

mkdir F:\系统文件夹\文档\WindowsPowerShell\Modules\PublishNuget
#在打印模块路径中选择一个模块路径创建PublishNuget模块

cd F:\系统文件夹\文档\WindowsPowerShell\Modules\PublishNuget
#进入PublishNuget模块路径

#将上一节PowerShell脚本内容使用gb2312编码保存成PublishNuget.psm1文件
#脚本里的[key]和[nuget server]替换成实际的服务器API密钥和nuget包源
#脚本里查找解决方案目录、项目目录和Nuget目录的函数按实际需要修改
#脚本里需要生成的项目按实际需要修改，并配置相关跳过参数
#将修改好的PublishNuget.psm1文件放到PublishNuget模块路径

New-ModuleManifest -Path .\PublishNuget.psd1 -ModuleVersion "1.0" -Author "NeedJustWord" -RootModule PublishNuget
#创建PublishNuget模块清单，此命令还指定版本号为1.0，作者为NeedJustWord

Add-Content $PROFILE.CurrentUserAllHosts 'Import-Module PublishNuget'
#当前用户导入PublishNuget模块
```



### PowerShell一键打包推送Nuget包

```powershell
#打开PowerShell，执行以下命令查看Start-PublishNuget命令说明
Get-Help Start-PublishNuget -full

#打开PowerShell，执行以下命令查看Start-PublishNugetSingle命令说明
Get-Help Start-PublishNugetSingle -full
```



### 参考资料

1. [批量更新Git和Svn仓库 | 你的就是我的](https://needjustword.github.io/powershell/2024/09/24/批量更新Git和Svn仓库.html)

